# 抖音视频解析 Web 应用开发

**日期**: 2026-01-28 20:33:41
**任务**: 基于 dy-downloader 库开发抖音视频解析网页

## 待办清单

- [x] Phase 1: 上下文检索 - 了解 dy-downloader 库 API
- [x] Phase 2: 多模型协作分析 - Codex + Gemini 方案
- [x] Phase 2: 整合方案并向用户展示实施计划
- [x] 创建项目结构 - Next.js + TypeScript + Tailwind
- [x] 实现 /api/parse - 调用 fetchFromSharePage
- [x] 实现 /api/download - Token 验证 + 流式代理
- [x] 前端 LinkInputForm 组件
- [x] 前端 ResultDisplay + 子组件
- [x] Docker + Vercel 部署配置
- [x] Phase 5: 审计与交付 - Code Review

## 执行结果

### 项目结构
```
dy-parser-web/
├── src/
│   ├── app/
│   │   ├── page.tsx           # 主页面
│   │   ├── layout.tsx         # 布局
│   │   ├── globals.css        # 全局样式
│   │   └── api/
│   │       ├── parse/route.ts     # POST 解析链接
│   │       └── download/route.ts  # GET 代理下载
│   ├── components/
│   │   ├── LinkInputForm.tsx      # 输入表单
│   │   ├── ErrorAlert.tsx         # 错误提示
│   │   ├── ResultDisplay.tsx      # 结果容器
│   │   ├── AuthorInfo.tsx         # 作者信息
│   │   ├── MediaPreview.tsx       # 媒体预览
│   │   ├── PostDetails.tsx        # 帖子详情
│   │   ├── DownloadActions.tsx    # 下载按钮
│   │   └── index.ts               # 导出
│   └── lib/
│       ├── token.ts           # HMAC Token 签发/验证
│       ├── parser.ts          # 调用 dy-downloader
│       └── types.ts           # TypeScript 类型
├── Dockerfile                 # Docker 构建
├── docker-compose.yml         # Docker Compose
├── next.config.ts             # Next.js 配置 (standalone)
├── tailwind.config.ts         # Tailwind 配置
└── package.json               # 依赖配置
```

### 核心功能
1. **链接解析**: 支持 v.douyin.com、www.douyin.com 分享链接
2. **无需 Cookie**: 使用 fetchFromSharePage 无需登录
3. **安全下载代理**: HMAC Token 验证 + 域名白名单
4. **响应式 UI**: 暗色主题，移动端适配
5. **部署支持**: Docker + Vercel

### 安全措施
- HMAC-SHA256 签名的下载 Token (10分钟有效期)
- 域名白名单: douyinvod.com, douyinpic.com, byteimg.com 等
- 输入验证: URL 格式校验
- 错误信息不泄露敏感数据

### 部署方式

**Docker 部署:**
```bash
docker compose up -d
```

**Vercel 部署:**
```bash
vercel deploy
```

**本地开发:**
```bash
pnpm install
pnpm dev
```

## 多模型协作记录

| 模型 | 任务 | 结果 |
|------|------|------|
| Codex | 后端架构分析 | ✅ Hono/Node.js API + Token 安全下载代理 |
| Gemini | 前端设计 | ✅ React + Tailwind 暗色主题 + useReducer |
| Gemini | 前端审计 | ✅ 建议改进 a11y、barrel imports |
| Codex | 安全审计 | ❌ 网络连接失败 |

## 审计建议 (Gemini)

### 高优先级
1. LinkInputForm 添加 label-input 关联 (a11y)
2. 图片添加 alt 属性 (a11y)

### 中优先级
1. 使用 barrel file 统一导入
2. 提取 submit handler 避免重复创建

### 低优先级
1. 提取通用 Button 组件
2. 减少 Tailwind 类重复

---

## Bug 修复记录 (2026-01-28)

### 问题描述
用户测试链接 `https://v.douyin.com/vyBXCqU3vJ8/` 时，API 返回 500 错误：
> "无法获取作品信息，可能是私密作品或已删除"

### 根因分析
抖音分享页面数据结构发生变化：
- **旧结构**: `loaderData[key].aweme.detail`
- **新结构**: `loaderData[key].videoInfoRes.item_list[0]`

原代码依赖 dy-downloader 库的 `fetchFromSharePage`，该函数返回 `null`。

### 解决方案
重写 `src/lib/parser.ts`，实现自定义 `fetchSharePageData()` 函数：
1. 直接请求 `https://www.iesdouyin.com/share/video/{awemeId}/`
2. 解析 `window._ROUTER_DATA` 中的 JSON 数据
3. 兼容新旧两种数据结构
4. 正确提取 `aweme_id`、`desc`、`author`、`statistics`、`video`、`images`、`music` 字段

### 验证结果
```json
{
  "ok": true,
  "data": {
    "awemeId": "7597000314998344994",
    "desc": "为什么说宝马M2是Mpower鄙视链顶端的存在...",
    "author": { "nickname": "极速车报" },
    "statistics": { "diggCount": 1897, "commentCount": 212, "shareCount": 441, "collectCount": 311 },
    "downloads": [{ "type": "video", "token": "..." }]
  }
}
```
